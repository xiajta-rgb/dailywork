name: 每日自动爬取GitHub趋势数据
on:
  workflow_dispatch:  # 仅手动触发（可按需加schedule）

permissions:
  contents: read

jobs:
  crawl-trend:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: 拉取仓库最新代码
        uses: actions/checkout@v4

      # 步骤1：配置Python环境+缓存pip依赖（核心！）
      - name: 配置Python 3.11环境（带缓存）
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # 启用pip依赖缓存，缓存路径：~/.cache/pip
          cache-dependency-path: |  # 指定依赖文件，仅当文件变化时重新缓存
            requirements.txt

      # 步骤2：安装Python依赖（命中缓存时只需1-2秒）
      - name: 安装Python依赖
        run: |
          python -m pip install --upgrade pip
          pip install playwright>=1.40.0

      # 步骤3：缓存Playwright浏览器（核心！避免每次重装Chromium）
      - name: 缓存Playwright浏览器
        id: cache-playwright
        uses: actions/cache@v4  # 通用缓存动作
        with:
          path: ~/.cache/ms-playwright  # Playwright浏览器缓存路径
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # 步骤4：安装Playwright浏览器（命中缓存时跳过安装）
      - name: 安装/恢复Playwright浏览器
        run: |
          # 若缓存未命中，安装浏览器；命中则跳过
          playwright install chromium --with-deps || true

      # 步骤5：执行脚本（无变化）
      - name: 执行核心操作
        env:
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          python daily_update.py
